name: Review docs and API references

on:
  push:
    branches:
      - main
    paths:
      # Trigger when auto-generated API docs change
      - 'agents/skills/mcp-web/api-reference*.md'
      # Trigger when public docs change (may inform examples)
      - 'docs/**/*.md'

permissions:
  contents: write
  pull-requests: write

jobs:
  review-agent-docs:
    runs-on: ubuntu-latest
    # Don't run on commits from this workflow (prevent loops)
    if: github.actor != 'github-actions[bot]'

    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 2  # Need previous commit for diff

      - uses: pnpm/action-setup@v4

      - uses: actions/setup-node@v6
        with:
          node-version-file: '.nvmrc'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install

      - name: Get changed files
        id: changed
        run: |
          # Get files changed in this push
          CHANGED_FILES=$(git diff --name-only HEAD~1 HEAD | grep -E '(agents/skills/mcp-web/api-reference.*\.md|docs/.*\.md)' || true)
          echo "files<<EOF" >> $GITHUB_OUTPUT
          echo "$CHANGED_FILES" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

          if [ -z "$CHANGED_FILES" ]; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT
          fi

      - name: Run AI documentation review
        if: steps.changed.outputs.has_changes == 'true'
        id: review
        env:
          OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
          CHANGED_FILES: ${{ steps.changed.outputs.files }}
        run: |
          # Run the review script
          npx tsx scripts/review-agent-docs.ts

          # Check if any files were modified
          if git diff --quiet agents/AGENTS.md agents/skills/mcp-web/SKILL.md agents/skills/mcp-web/examples.md; then
            echo "has_suggestions=false" >> $GITHUB_OUTPUT
          else
            echo "has_suggestions=true" >> $GITHUB_OUTPUT

            # Capture the summary for PR body
            if [ -f /tmp/review-summary.md ]; then
              SUMMARY=$(cat /tmp/review-summary.md)
              echo "summary<<EOF" >> $GITHUB_OUTPUT
              echo "$SUMMARY" >> $GITHUB_OUTPUT
              echo "EOF" >> $GITHUB_OUTPUT
            fi
          fi

      - name: Create Pull Request
        if: steps.review.outputs.has_suggestions == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Configure git
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # Create branch
          BRANCH="docs/agent-docs-update-$(git rev-parse --short HEAD)"
          git checkout -b "$BRANCH"

          # Commit changes
          git add agents/AGENTS.md agents/skills/mcp-web/SKILL.md agents/skills/mcp-web/examples.md
          git commit -m "docs: Update agent documentation based on API changes"

          # Push branch
          git push origin "$BRANCH"

          # Create draft PR with properly formatted body
          cat > /tmp/pr-body.md <<'PRBODY'
          ## Summary

          This PR contains AI-suggested updates to agent documentation based on recent changes to:
          - API reference docs (`api-reference*.md`)
          - Public documentation (`docs/**/*.md`)

          ### Changes Suggested

          ${{ steps.review.outputs.summary }}

          ---

          > **Note**: This PR was automatically generated by Claude. Please review the changes carefully before merging.

          ### Files Modified
          - `agents/AGENTS.md`
          - `agents/skills/mcp-web/SKILL.md`
          - `agents/skills/mcp-web/examples.md`
          PRBODY

          # Ensure labels exist (create if missing)
          gh label create "documentation" --color "0075ca" --description "Documentation updates" 2>/dev/null || true
          gh label create "automated" --color "d4c5f9" --description "Automated PRs" 2>/dev/null || true

          gh pr create \
            --title "docs: Update agent documentation" \
            --body-file /tmp/pr-body.md \
            --draft \
            --label "documentation" \
            --label "automated"
